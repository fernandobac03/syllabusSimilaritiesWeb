wkhomeControllers.controller("clusterGroupByCloud",["$timeout","$scope","globalData","sparqlQuery","clustersQuery","searchData","$route","$window","$routeParams",function(e,t,r,a,o,l,u,s,n){function c(){var e=r.PREFIX+" CONSTRUCT { ?keyword rdfs:label ?key } \tFROM <"+r.centralGraph+'>  WHERE {      SELECT  (count(?key) as ?k) ?key      WHERE {          ?subject bibo:Quote ?key.          BIND(REPLACE(?key, " ", "_", "i") AS ?unickey).          BIND(IRI(?unickey) as ?keyword)      }      GROUP BY ?keyword  ?key      HAVING(?k > 10) }';a.querySrv({query:e},function(e){waitingDialog.show(),jsonld.compact(e,r.CONTEXT,function(e,r){_.map(r["@graph"],function(e){var r={};r.id=e["@id"],r.tag=e["rdfs:label"],t.themes.push({tag:r.tag})}),h(),waitingDialog.hide()})})}function h(){t.$apply(function(){t.relatedthemes=t.themes,t.selectedItem=l.researchArea,l.allkeywords=t.themes})}function d(e,t){}function f(t,o){var u=[],s=[];new Array;if(null==l.clustersAuthors||0==l.clustersAuthors.length){l.clustersAuthors=[];var n=r.PREFIX+" CONSTRUCT {   ?author foaf:name ?name.   ?author uc:hasCluster ?clusterId.   ?author rdfs:label ?label.   ?author bibo:Quote ?keywords } WHERE {    graph <"+r.clustersGraph+">     {       ?clusterId uc:hasPerson ?author.      ?clusterId rdfs:label ?label.      {         select DISTINCT ?author ?name ?keywords         where         {          graph <"+r.centralGraph+">           {              ?author foaf:name ?name.              ?author foaf:publications ?publicationUri.              ?publicationUri bibo:Quote ?keywords.          }        } group by ?author ?name ?keywords       }    }}";a.querySrv({query:n},function(t){jsonld.compact(t,r.CONTEXT,function(t,r){_.map(r["@graph"],function(e){var t={},r=e["uc:hasCluster"],a="";if(null!=e["bibo:Quote"]&&(e["bibo:Quote"].constructor===Array||e["bibo:Quote"]instanceof Array))for(i=0;i<e["bibo:Quote"].length&&i<12;i++)a+=0==i?e["bibo:Quote"][i]:", "+e["bibo:Quote"][i];if(null!=r&&(r.constructor===Array||r instanceof Array))for(i=0;i<r.length;i++)t.IdAuthor=e["@id"],t.IdCluster=e["uc:hasCluster"][i]["@id"],t.ClusterName=e["rdfs:label"][i],t.Author=e["foaf:name"],t.Keyword=a,t.Title=e["foaf:name"],t.URI=e["foaf:name"],s.push({idAuthor:t.IdAuthor,cluster:t.IdCluster,clusterName:t.ClusterName,author:t.Author,keyword:t.Keyword,title:t.Title,uri:t.URI});else t.IdAuthor=e["@id"],t.IdCluster=e["uc:hasCluster"]["@id"],t.ClusterName=e["rdfs:label"],t.Author=e["foaf:name"],t.Keyword=a,t.Title=e["foaf:name"],t.URI=e["foaf:name"],s.push({idAuthor:t.IdAuthor,cluster:t.IdCluster,clusterName:t.ClusterName,author:t.Author,keyword:t.Keyword,title:t.Title,uri:t.URI})});var a=new Array;for(i=0,len=s.length;i<len;i++)null==a[s[i].cluster.toString()]&&(a[s[i].cluster.toString()]=new Array,a[s[i].cluster.toString()][0]=1,a[s[i].cluster.toString()][1]=0),a[s[i].cluster.toString()][0]=a[s[i].cluster.toString()][0]+1;for(i=0,len=s.length;i<len;i++)a[s[i].cluster.toString()][0]>4&&a[s[i].cluster.toString()][1]<95&&(u.push(s[i]),a[s[i].cluster.toString()][1]+=1);l.clustersAuthors=u,e(m(l.clustersAuthors,o)),l.areaSearch=null})})}else e(m(l.clustersAuthors,o)),l.areaSearch=null}function m(r,a){e(function(){t.data=[{value:r,group:a}],t.dataaux=r})}$("html,body").animate({scrollTop:$("#scrollToTop").offset().top},"slow"),t.gbselectedItem="cluster",t.$watch("searchData.areaSearch",function(e,r,a){if(l.areaSearch){var o=l.areaSearch["@graph"];if(o){var u=_.map(o,function(e){var t={};return t.id=e["@id"],t.label=e["rdfs:label"],t});t.candidates=u,t.selectedAuthor=function(e,r){$("#searchResults").modal("hide"),l.researchArea=r,t.selectedItem=r},waitingDialog.hide(),$("#searchResults").modal("show")}else alert("Information not found"),s.location.hash="/",waitingDialog.hide()}},!0),l.allkeywords?(t.relatedthemes=l.allkeywords,t.selectedItem=l.researchArea):(t.themes=[],waitingDialog.show(),c()),t.$watch("gbselectedItem",function(){d(t.dataaux,t.gbselectedItem)}),t.$watch("selectedItem",function(){f(t.selectedItem,t.gbselectedItem)}),t.clickonAuthor=function(e){clickonRelatedauthor(e)},clickonRelatedauthor=function(e){var o=r.PREFIX+" CONSTRUCT {   <"+e+"> foaf:name ?name; a foaf:Person   }    WHERE  {Graph <"+r.centralGraph+">{     <"+e+"> a foaf:Person.     <"+e+"> foaf:name ?name } }";a.querySrv({query:o},function(a){jsonld.compact(a,r.CONTEXT,function(r,a){t.$apply(function(){l.authorSearch=a,s.location.hash="/"+n.lang+"/w/search?"+e})})})}}]);