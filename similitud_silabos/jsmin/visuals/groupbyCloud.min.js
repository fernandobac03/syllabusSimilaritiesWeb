"use strict";var cloudGroup=angular.module("cloudGroup",[]);cloudGroup.factory("d3",function(){return d3}),cloudGroup.directive("cloudGroup",["$routeParams","d3","sparqlQuery","globalData",function(t,a,e,n){function r(r,l,c,s){function d(t,e){for(var n=a.max(_.pluck(t,e)),r=t,i=0;i<t.length;i++)r[i].radius=""!=e?C*(t[i][e]/n):20,r[i].x=t[i].x?t[i].x:Math.random()*k,r[i].y=t[i].y?t[i].y:Math.random()*F;return r}function p(t){if(console.log(t),a.selectAll("circle").transition().style("fill",function(a){return t?T[t][a[t]]:T["default"]}).duration(1e3),$(".colors").empty(),t)for(var e in T[t])$(".colors").append('<div class="col-xs-1 color-legend" style="background:'+T[t][e]+';">'+e+"</div>")}function f(t){var a=O(t,[k,F]);j.on("tick",m(a,t)),h(a),j.start()}function m(t,a){for(var e={},n=0;n<t.length;n++)e[t[n].name]=t[n];return function(t){for(var n=0;n<A.length;n++){var r=A[n],i=e[r[a]];r.y+=(i.y+i.dy/2-r.y)*t.alpha,r.x+=(i.x+i.dx/2-r.x)*t.alpha}N.each(g(.11)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}}function h(t){w.selectAll(".label").remove(),w.selectAll(".label").data(t).enter().append("text").attr("class","label-groupby").attr("fill","red").text(function(t){if(null!=t.name&&(t.name.constructor===Array||t.name instanceof Array)&&(t.name=t.name[0]),null!=t.name&&("string"==typeof t.name||t.name instanceof String)){var a=t.name.split(","),e=[""],n=[""];return null!=a[0]&&(e=a[0].trim().split(" ")),null!=a[1]&&(n=a[1].trim().split(" ")),e[0]+", "+n[0]}return t.name}).attr("transform",function(t){return"translate("+(t.x+t.dx/2-40)+", "+(t.y+20)+")"})}function b(){$(".popover").each(function(){$(this).remove()})}function v(t){$(this).popover({placement:"auto top",container:"body",trigger:"manual",html:!0,content:function(){return null!=t.name&&(t.name.constructor===Array||t.name instanceof Array)&&(t.name=t.name[0]),"Nombre: "+t.name+"<br />Institucion: "+t.organization+"<br />"}}),$(this).popover("show")}function g(t){var e=a.geom.quadtree(A);return function(a){var n=a.radius+R+S,r=a.x-n,i=a.x+n,u=a.y-n,o=a.y+n;e.visit(function(e,n,l,c,s){if(e.point&&e.point!==a){var d=a.x-e.point.x,p=a.y-e.point.y,f=Math.sqrt(d*d+p*p),m=a.radius+e.point.radius+S;f<m&&(f=(f-m)/f*t,a.x-=d*=f,a.y-=p*=f,e.point.x+=d,e.point.y+=p)}return n>i||c<r||l>o||s<u})}}function y(r){var i=$("div.tree-node-info"),u=$("div.tree-node-author-info .authorsByClusters");u.html("");var o=$("div.tree-node-author-info .authorsByPublications");if(o.html(""),x(r),i){var l=r.id,c=$("div.head-info");c.find("title").text("ddddddtitletitle"),c.html(""),s.$parent.exportReport(r.id);var d,p=$("<div>");d="es"===t.lang?$('<span class="label label-primary" style="font-size:35px">').text("PUBLICACIONES DE: "+r.name):$('<span class="label label-primary" style="font-size:35px">').text("PUBLICATIONES DE: "+r.name),p.append(d),p.append("</br>"),c.append(p);var f=n.PREFIX+' CONSTRUCT {  ?publications a bibo:Document.  ?publications dct:title ?title.  ?publications bibo:abstract ?abstract.  ?publications bibo:uri ?uri.  ?publications bibo:Quote ?keywords  }  WHERE {   SELECT ?publications ?title ?uri (group_concat(distinct ?abst;separator=" ") as ?abstract) (group_concat(distinct ?key;separator=", ") as ?keywords)  WHERE  {     GRAPH <'+n.centralGraph+">      {      <"+l+"> foaf:publications ?publications.      ?publications dct:title ?title .      OPTIONAL { ?publications bibo:uri  ?uri. }     OPTIONAL { ?publications bibo:Quote ?key.}     OPTIONAL { ?publications bibo:abstract  ?abst  }     }  } GROUP BY ?publications ?title ?uri }";waitingDialog.show('Buscando publicaciones de:  "'+r.name+'"'),e.querySrv({query:f},function(t){jsonld.compact(t,n.CONTEXT,function(t,a){if(a){var e=a["@graph"],n=_.where(e,{"@type":"bibo:Document"}),r=n.length?n:[n];s.ifClick({value:r}),waitingDialog.hide()}else waitingDialog.hide();b()})})}return a.event.preventDefault()}function x(t){var a=t.id;if(t.name){var e=String.format(I,t.name,a);E(e,"authorsByClusters");var e=String.format(G,t.name,a);E(e,"authorsByPublications")}}function E(t,a){var r=t;e.querySrv({query:r},function(t){jsonld.compact(t,n.CONTEXT,function(t,e){if(e){var n=e["@graph"];if(n){var r=$("div.tree-node-author-info ."+a);r.html("");var i=n.length?n:[n],u=$("<div>");r.append(u),_.map(i,function(t){var a=(JSON.stringify(t),$("<a class='relatedauthors' target='blank' onclick = 'return clickonRelatedauthor(\""+t["@id"]+"\")'  >").text(""));return a.append(t["rdfs:label"]),u.append(a),u.append("</br>"),a})}}})})}var T={exchange:{NYSE:"red",NASDAQ:"orange",TSX:"blue","TSX-V":"green"},volumeCategory:{Top:"mediumorchid",Middle:"cornflowerblue",Bottom:"gold"},lastPriceCategory:{Top:"aqua",Middle:"chartreuse",Bottom:"crimson"},standardDeviationCategory:{Top:"slateblue",Middle:"darkolivegreen",Bottom:"orangered"},"default":"#5882FA"},C=350,k=Math.max(document.documentElement.clientWidth,window.innerWidth||0)-300,F=Math.max(document.documentElement.clientHeight,window.innerHeight||0),P=(a.scale.ordinal().range(["#FF00CC","#FF00CC","#00FF00","#00FF00","#FFFF00","#FF0000","#FF0000","#FF0000","#FF0000","#7F0000"]),r);P.html("");var w=r.append("svg").attr("width",k).attr("height",F),A=d(l,u),S=8,R=a.max(_.pluck(A,"radius")),O=function(t,e){var n,r;return n=_.uniq(_.pluck(A,t)).map(function(t){return{name:t,value:1}}),r=a.layout.treemap().size(e).ratio(1),r.nodes({children:n}),n},N=w.selectAll("circle").data(A);N.enter().append("circle").attr("class","node").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.x}).attr("r",function(t){return t.radius}).style("fill",function(t,a){return T["default"]}).on("mouseover",function(t){v.call(this,t)}).on("mouseout",function(t){b()}).on("click",y),$("#group").change(function(){i=this.value,f(i)}),$("#size").change(function(){var t=this.value,e=a.max(_.pluck(A,t));a.selectAll("circle").data(d(A,this.value)).transition().attr("r",function(a,n){return t?C*(A[n][t]/e):15}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).duration(2e3),u=this.value,j.start()}),$("#color").change(function(){o=this.value,p(this.value)});var j=a.layout.force();p(o),f(c);var I=n.PREFIX+' CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}"  .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {  SELECT DISTINCT  ?subject ?name (count(?pub) as ?totalPub) WHERE {    GRAPH <'+n.clustersGraph+">          {  ?cluster uc:hasPerson <{1}> . ?cluster uc:hasPerson ?subject.           ?subject foaf:publications ?pub          { SELECT ?name {      graph <"+n.centralGraph+">            {        \t?subject foaf:name ?name.            } }  }              }      } group by ?subject ?name           }}    ",G=n.PREFIX+'  CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}" .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {      SELECT ?subject (count(?pub) as ?totalPub) ?name          WHERE {              GRAPH <'+n.centralGraph+"> {              <{1}> foaf:publications ?pub.              ?subject foaf:publications ?pub.             ?subject foaf:name ?name.  }              }          GROUP BY ?subject ?name   }  }"}var i="",u="",o="";return{restrict:"E",scope:{data:"=",ifClick:"&"},compile:function(t,e,n){var i=parseInt(t.css("width")),u=parseInt(t.css("height")),o=(e.ctWidth?e.ctWidth:i,e.ctHeight?e.ctHeight:u,a.select(t[0]));return function(t,a,e){t.$watch("data",function(t,a,e){if(e.data&&e.data[0]&&e.data[0].value&&e.data[0].value[0]&&!a){var n=e.data[0].value,i=e.data[0].group;r(o,n,i,e)}else if(e.data&&e.data[0]&&e.data[0].value&&e.data[0].value[0]&&JSON.stringify(t[0].value[0].name?t[0].value[0].name:t)!=(a[0]&&a[0].value?JSON.stringify(a[0].value[0]?a[0].value[0].name:a):null)){var n=e.data[0].value,i=e.data[0].group;r(o,n,i,e)}},!0)}}}}]);