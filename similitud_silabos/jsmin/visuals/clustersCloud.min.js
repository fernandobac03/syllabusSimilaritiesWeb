"use strict";var clusterKeywCloud=angular.module("clusterKeywCloud",[]);clusterKeywCloud.factory("d3",function(){return d3}),clusterKeywCloud.directive("clusterKeywCloud",["d3","globalData","sparqlQuery",function(t,e,n){function r(){$(".popover").each(function(){$(this).remove()})}function a(t){$(this).popover({placement:"auto top",container:"body",trigger:"manual",html:!0,content:function(){return null!=t["abstract"]&&(t["abstract"].constructor===Array||t["abstract"]instanceof Array)&&(t["abstract"]=t["abstract"][0]),"<strong>Cluster:</strong> "+t.label+"<br /><strong>Authors</strong> in this cluster with publications that contain "+W.toString().replace("Clusters that contain ","").replace(' Keyword".',"").replace("Clusters que contienen ","")}}),$(this).popover("show")}var u,c,o,i,l,s,d,f,h,p,b,g,v,y,m,w,x,C,T,R,j,E,k,I,S,A,D,U,q,K,Q,N,W="";d=[],R=null,y=null,m={top:5,right:0,bottom:0,left:0},w=35,j=t.scale.sqrt().range([0,w]),E=function(t){return parseInt(t.value)},g=function(t){return t.label},k=function(t){return t.label},l=10,x=12,v=.1,S=function(t){return t.forEach(function(t){t.value=parseInt(t.value)}),t},I=function(t){var e;return e=.1*t.alpha,R.each(h(e)).each(i(v)).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),y.style("left",function(t){return 17+(m.left+t.x)-t.dx/2+"px"}).style("top",function(t){return 140+(m.top+t.y)-t.dy/2+"px"})},u=function(e){return e.each(function(e){var n,r,a;return d=S(e),n=t.max(d,function(t){return E(t)}),j.domain([0,n]),r=t.select(this).selectAll("svg").data([d]),a=r.enter().append("svg"),r.attr("width",K+m.left+m.right),r.attr("height",b+m.top+m.bottom),R=a.append("g").attr("id","gbubble-nodes").attr("transform","translate("+m.left+","+m.top+")"),R.append("rect").attr("id","gbubble-background").attr("width",K).attr("height",b),y=t.select(this).selectAll("#gbubble-labels").data([d]).enter().append("div").attr("id","gbubble-labels"),A(),t.select(window)})},A=function(){return d.forEach(function(t,e){return t.forceR=Math.max(x,j(E(t)))}),f.nodes(d).start(),q(),U()},q=function(){return R=R.selectAll(".gbubble-node").data(d,function(t){return g(t)}),R.exit().remove(),R.enter().append("a").attr("class","gbubble-node").call(f.drag).call(s).append("circle").attr("id","gcircle").attr("r",function(t){return j(E(t))})},U=function(){var t;return y=y.selectAll(".gbubble-label").data(d,function(t){return g(t)}),y.exit().remove(),t=y.enter().append("a").attr("class","gbubble-label").call(f.drag).call(s),t.append("div").attr("class","gbubble-label-name").text(function(t){return k(t)}),t.append("div").attr("class","gbubble-label-value").text(function(t){return E(t)}),y.style("font-size",function(t){return Math.max(8,j(E(t)/5))+"px"}).style("width",function(t){return.1*j(E(t))+"px"}),y.append("span").text(function(t){return k(t)}).each(function(t){return t.dx=Math.max(2.5*j(E(t)),this.getBoundingClientRect().width)}).remove(),y.style("width",function(t){return t.dx+"px"}),y.each(function(t){return t.dy=this.getBoundingClientRect().height})},h=function(t){var e,n,r,a;return r=K/2,a=b/2,e=t/8,n=t,function(t){return t.x+=(r-t.x)*e,t.y+=(a-t.y)*n}},i=function(t){return function(e){return d.forEach(function(n){var r,a,u,c,o,i;if(e!==n&&(o=e.x-n.x,i=e.y-n.y,r=Math.sqrt(o*o+i*i),a=e.forceR+n.forceR+l,r<a))return r=(r-a)/r*t,u=o*r,c=i*r,e.x-=u,e.y-=c,n.x+=u,n.y+=c})}},s=function(t){return t.on("click",o),t.on("mouseover",T),t.on("mouseout",C)},c=function(){return location.replace("#")},o=function(r){var a=$("div.tree-node-info");if(a){var u=r.label,c=$("div.head-info");c.find("title").text("ddddddtitletitle"),c.html(""),Q.$parent.exportReport(r.id);var o=$("<div>"),i=$('<span class="label label-primary" style="font-size:35px">').text("AUTHORS OF CLUSTER "+r.label);o.append(i),o.append("</br>"),c.append(o);var l=e.PREFIX+"CONSTRUCT {     ?subject a foaf:Person. \t?subject foaf:name ?name. \t?subject bibo:Quote ?keywords. } where{ SELECT DISTINCT ?subject ?name ?keywords WHERE  {     graph <"+e.clustersGraph+">           {               <"+r.id+">  uc:hasPerson  ?subject.     {      \t\t\t       select DISTINCT ?subject ?name ?keywords            \t\t       where            \t\t                     {            \t                       graph <"+e.centralGraph+">            \t\t\t                             {            \t\t\t\t                                 ?subject foaf:name ?name.                               ?subject foaf:publications ?publicationUri.  \t\t\t\t\t\t\t  ?publicationUri dct:title ?title .                           ?publicationUri bibo:Quote ?keywords.                         }          \t\t\t                 } group by ?subject ?name ?keywords         \t }            }  }  } ";waitingDialog.show("Searching Authors of the cluster "+u),n.querySrv({query:l},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var n=[];_.map(e["@graph"],function(t){for(var e,r=0;r<20&&r<t["bibo:Quote"].length;r++)e=(e?e+", ":"")+t["bibo:Quote"][r];n.push({"@id":t["@id"],"@type":t["@type"],"bibo:Quote":e,"foaf:name":t["foaf:name"]})});var r=n,a=_.where(r,{"@type":"foaf:Person"}),u=a.length?a:[a];Q.ctrlFn({value:u}),waitingDialog.hide()}else waitingDialog.hide()})})}return t.event.preventDefault()},p=function(){var t;return t=decodeURIComponent(location.hash.substring(1)).trim(),D(t)},D=function(e){return R.classed("gbubble-selected",function(t){return e===g(t)}),e.length>0?t.select("#status").html('<h3>The word <span class="active">'+e+"</span> is now active</h3>"):t.select("#status").html("<h3>No word is active</h3>")},T=function(t){return a.call(this,t),R.classed("gbubble-hover",function(e){return e===t})},C=function(t){return r(),R.classed("gbubble-hover",!1)},u.jitter=function(t){return arguments.length?(v=t,f.start(),u):v},u.height=function(t){return arguments.length?(b=t,u):b},u.width=function(t){return arguments.length?(K=t,u):K},u.r=function(t){return arguments.length?(E=t,u):E};var F=function(e,n,r,a,c,o,i){K=n,b=r,Q=c,N=o,W=i,t.select("div.head-pagetitle").text(W),f=t.layout.force().gravity(0).charge(0).size([K,b]).on("tick",I),e.datum(a).call(u)};return{restrict:"E",scope:{ctrlFn:"&",data:"="},compile:function(e,n,r){var a=parseInt(e.css("width")),u=parseInt(e.css("height")),c=n.ctWidth?n.ctWidth:a,o=n.ctHeight?n.ctHeight:u,i=t.select(e[0]);return function(t,e,n){t.$watch("data",function(t,e,r){var a=r.data;if(a){var u=a.data,l=a.schema,s=l.fields,d=[];_.each(u["@graph"],function(t,e){if(t["rdfs:label"]){var n=t["@id"],r=s[1].replace("uc:","http://ucuenca.edu.ec/ontology#"),a="";(t[s[1]]||t[r])&&(a=t[s[1]]?t[s[1]]["@value"]:t[r]["@value"]),"uc:resulttitle"!=t[s[0]].toString().toLowerCase()&&"http://ucuenca.edu.ec/wkhuska/resource/resultTitle"!=t[s[0]]&&d.push({id:n,label:t[s[0]],value:a})}});try{W=_.findWhere(u["@graph"],{"@type":"uc:pagetitle"})["uc:viewtitle"]}catch(f){W=_.findWhere(u["@graph"],{"@type":"http://ucuenca.edu.ec/resource/pagetitle"})["http://ucuenca.edu.ec/resource/viewtitle"]}F(i,c,o,d,r,n,W)}},!0)}}}}]);